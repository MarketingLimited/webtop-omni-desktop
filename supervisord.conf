[supervisord]
nodaemon=true
user=root
loglevel=warn
minfds=1024
minprocs=200

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
username=admin
password=admin

[program:Xvfb]
command=/usr/bin/Xvfb :1 -screen 0 1920x1080x24 -dpi 96 +extension GLX +render -noreset -ac
priority=10
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/xvfb.log
stderr_logfile=/var/log/supervisor/xvfb.log

[program:dbus]
command=/bin/sh -c "rm -f /var/run/dbus/pid && mkdir -p /run/dbus && /usr/bin/dbus-daemon --system --nofork --nosyslog"
priority=15
autostart=true
autorestart=true
user=root
startsecs=5
startretries=5
stdout_logfile=/var/log/supervisor/dbus.log
stderr_logfile=/var/log/supervisor/dbus.log

[program:accounts-daemon]
command=/usr/sbin/accounts-daemon
priority=18
autostart=true
autorestart=true
user=root
startsecs=5
startretries=5
stdout_logfile=/var/log/supervisor/accounts-daemon.log
stderr_logfile=/var/log/supervisor/accounts-daemon.log

[program:pipewire]
command=/usr/local/bin/wait-for-service.sh /var/run/dbus/system_bus_socket /usr/bin/pipewire
priority=25
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PIPEWIRE_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s/pipewire
startretries=5
startsecs=8
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/pipewire.log
stderr_logfile=/var/log/supervisor/pipewire.log

[program:wireplumber]
command=/usr/local/bin/wait-for-service.sh /run/user/%(ENV_DEV_UID)s/pipewire-0 /usr/bin/wireplumber
priority=26
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PIPEWIRE_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s/pipewire
startretries=5
startsecs=10
stopwaitsecs=10
stdout_logfile=/var/log/supervisor/wireplumber.log
stderr_logfile=/var/log/supervisor/wireplumber.log

[program:KDE]
command=/bin/sh -c "sleep 15; export DISPLAY=:1; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; exec startplasma-x11"
priority=30
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startsecs=15
startretries=2
stdout_logfile=/var/log/supervisor/kde.log
stderr_logfile=/var/log/supervisor/kde.log

[program:X11VNC]
command=/bin/sh -c "sleep 35; exec /usr/bin/x11vnc -display :1 -rfbport 5901 -forever -shared -nopw -xkb -noxrecord -noxfixes -noxdamage -wait 5"
priority=35
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=8
startretries=3
stdout_logfile=/var/log/supervisor/x11vnc.log
stderr_logfile=/var/log/supervisor/x11vnc.log

[program:noVNC]
command=/usr/bin/websockify --web=/usr/share/novnc/ 80 localhost:5901
priority=37
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/novnc.log
stderr_logfile=/var/log/supervisor/novnc.log


[program:sshd]
command=/usr/sbin/sshd -D
priority=42
autostart=true
autorestart=true
stopsignal=TERM
user=root
stdout_logfile=/var/log/supervisor/sshd.log
stderr_logfile=/var/log/supervisor/sshd.log

[program:ttyd]
command=/bin/bash /usr/local/bin/ttyd-wrapper.sh
priority=45
autostart=true
autorestart=true
stopsignal=TERM
user=root
environment=TTYD_USER=%(ENV_TTYD_USER)s,TTYD_PASSWORD=%(ENV_TTYD_PASSWORD)s,TTYD_PORT=7681
startsecs=10
startretries=5
exitcodes=0,130
stdout_logfile=/var/log/supervisor/ttyd.log
stderr_logfile=/var/log/supervisor/ttyd.log

[program:AudioValidation]
command=/bin/sh -c "sleep 30; /usr/local/bin/audio-validation.sh"
priority=28
autostart=true
autorestart=false
stopsignal=TERM
user=root
environment=DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
exitcodes=0,1
startsecs=5
startretries=2
stdout_logfile=/var/log/supervisor/audio-validation.log
stderr_logfile=/var/log/supervisor/audio-validation.log


[program:AudioMonitor]
command=/bin/sh -c "sleep 60; /usr/local/bin/audio-monitor.sh intelligent-monitor"
priority=27
autostart=true
autorestart=unexpected
stopsignal=TERM
user=root
environment=DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
startsecs=30
startretries=2
exitcodes=0,1
autorestart_backoff=120
stdout_logfile=/var/log/supervisor/audio-monitor.log
stderr_logfile=/var/log/supervisor/audio-monitor.log

[program:ServiceHealth]
command=/bin/sh -c "sleep 75; /usr/local/bin/service-health.sh smart-monitor"
priority=55
autostart=true
autorestart=unexpected
stopsignal=TERM
user=root
exitcodes=0,1
startsecs=20
startretries=1
autorestart_backoff=300
stdout_logfile=/var/log/supervisor/health.log
stderr_logfile=/var/log/supervisor/health.log

[program:CreateVirtualPipeWireDevices]
command=/bin/bash -c "sleep 15 && /usr/local/bin/create-virtual-pipewire-devices.sh"
user=root
autostart=true
autorestart=false
startsecs=5
startretries=2
stdout_logfile=/var/log/supervisor/pipewire-devices.log
stderr_logfile=/var/log/supervisor/pipewire-devices.log
environment=DEV_USERNAME="%(ENV_DEV_USERNAME)s",DEV_UID="%(ENV_DEV_UID)s",DEV_GID="%(ENV_DEV_GID)s",XDG_RUNTIME_DIR="/run/user/%(ENV_DEV_UID)s"
priority=27
exitcodes=0,1

[program:SetupDesktop]
command=/bin/sh -c 'sleep 55; /usr/local/bin/setup-desktop.sh'
priority=50

[program:SetupUniversalAudio]
command=/bin/bash /usr/local/bin/setup-universal-audio.sh
user=root
autostart=true
autorestart=false
startsecs=0
startretries=0
stdout_logfile=/var/log/supervisor/universal-audio.log
stderr_logfile=/var/log/supervisor/universal-audio.log
priority=405
depends_on=noVNC
exitcodes=0

[program:WebRTCBridge]
command=/usr/bin/node /opt/webrtc-bridge/server.js
priority=27
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
stdout_logfile=/var/log/supervisor/webrtc-bridge.log
stderr_logfile=/var/log/supervisor/webrtc-bridge.log

[program:SystemValidation]
command=/bin/sh -c "sleep 120; /usr/local/bin/system-validation.sh --optimized"
priority=60
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0,1,2
startsecs=10
startretries=1
stdout_logfile=/var/log/supervisor/validation.log
stderr_logfile=/var/log/supervisor/validation.log

[group:core]
programs=Xvfb,dbus,accounts-daemon
priority=10

[group:audio]
programs=pipewire,wireplumber,AudioValidation,CreateVirtualPipeWireDevices,AudioMonitor,WebRTCBridge
priority=25

[program:PipeWireRecovery]
command=/bin/bash -c "sleep 45; /usr/local/bin/pipewire-recovery.sh check || /usr/local/bin/pipewire-recovery.sh recover"
priority=29
autostart=true
autorestart=false
stopsignal=TERM
user=root
environment=DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
exitcodes=0,1
startsecs=5
startretries=1
stdout_logfile=/var/log/supervisor/pipewire-recovery.log
stderr_logfile=/var/log/supervisor/pipewire-recovery.log

[program:ServiceRecoveryManager]
command=/bin/bash -c "sleep 90; /usr/local/bin/service-recovery-manager.sh monitor"
priority=58
autostart=true
autorestart=unexpected
stopsignal=TERM
user=root
environment=DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
startsecs=30
startretries=2
exitcodes=0,1
autorestart_backoff=300
stdout_logfile=/var/log/supervisor/service-recovery.log
stderr_logfile=/var/log/supervisor/service-recovery.log

[group:desktop]
programs=KDE
priority=30

[group:remote]
programs=X11VNC,noVNC,sshd,ttyd
priority=40

[group:monitoring]
programs=ServiceHealth,SystemValidation,ServiceRecoveryManager
priority=55
