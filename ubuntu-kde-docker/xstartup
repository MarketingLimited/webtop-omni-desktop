#!/bin/sh

# Disable xmodmap to prevent interfering with keyboard layouts
export XKL_XMODMAP_DISABLE=1

# Ensure essential binaries are in PATH
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Default to VNC display :1 if DISPLAY is unset
export DISPLAY=${DISPLAY:-:1}

# Prevent conflicts with existing desktop sessions
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS

# Run KDE Plasma inside a D-Bus session
DEV_USERNAME="${DEV_USERNAME:-devuser}"
DEV_UID="${DEV_UID:-1000}"
export XDG_RUNTIME_DIR="/run/user/${DEV_UID}"

if [ "$(id -un)" = "$DEV_USERNAME" ]; then
  exec dbus-launch --exit-with-session /usr/bin/startplasma-x11
else
  exec su - "$DEV_USERNAME" -c "export XDG_RUNTIME_DIR=/run/user/${DEV_UID}; dbus-launch --exit-with-session /usr/bin/startplasma-x11"
fi
