[supervisord]
nodaemon=true
user=root
loglevel=info
minfds=1024
minprocs=200
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:dbus]
command=/usr/local/bin/start-dbus-first.sh
priority=10
autostart=true
autorestart=true
user=root
startsecs=10
startretries=5
stopwaitsecs=10
killasgroup=true
stopasgroup=true
stdout_logfile=/var/log/supervisor/dbus.log
stderr_logfile=/var/log/supervisor/dbus.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3

[program:pulseaudio]
command=/bin/sh -c "sleep 15; /usr/local/bin/wait-for-dbus.sh; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; export PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse; mkdir -p /run/user/%(ENV_DEV_UID)s/pulse; chown %(ENV_DEV_USERNAME)s:%(ENV_DEV_USERNAME)s /run/user/%(ENV_DEV_UID)s/pulse; exec /usr/bin/pulseaudio --daemonize=no --disallow-exit --exit-idle-time=-1 --system=false --file=/home/%(ENV_DEV_USERNAME)s/.config/pulse/default.pa"
priority=20
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse,DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
startretries=5
startsecs=10
stopwaitsecs=5
stdout_logfile=/var/log/supervisor/pulseaudio.log
stderr_logfile=/var/log/supervisor/pulseaudio.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

[program:audiovalidation]
command=/bin/sh -c "/usr/local/bin/wait-for-dbus.sh && /usr/local/bin/audio-validation.sh"
priority=25
autostart=true
autorestart=false
user=root
startsecs=10
startretries=2
exitcodes=0,1
stdout_logfile=/var/log/supervisor/audio-validation.log
stderr_logfile=/var/log/supervisor/audio-validation.log

[program:audiomonitor]
command=/bin/sh -c "sleep 30; /usr/local/bin/audio-monitor.sh monitor"
priority=30
autostart=%(ENV_AUTOSTART_AUDIOMONITOR)s
autorestart=true
user=root
startsecs=15
startretries=2
exitcodes=0,1
stopwaitsecs=5
stdout_logfile=/var/log/supervisor/audio-monitor.log
stderr_logfile=/var/log/supervisor/audio-monitor.log

[program:kasmvnc]
command=/bin/sh -c "/usr/local/bin/wait-for-dbus.sh && /usr/local/bin/start-vnc-robust.sh"
priority=35
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
startsecs=15
startretries=3
exitcodes=0,1,2
stopwaitsecs=10
killasgroup=true
environment=KASMVNC_PORT="%(ENV_KASMVNC_PORT)s",KASMVNC_VNC_PORT="%(ENV_KASMVNC_VNC_PORT)s",DISPLAY=":1",HOME="/home/%(ENV_DEV_USERNAME)s",USER="%(ENV_DEV_USERNAME)s",XDG_RUNTIME_DIR="/run/user/%(ENV_DEV_UID)s"
stdout_logfile=/var/log/supervisor/kasmvnc.log
stderr_logfile=/var/log/supervisor/kasmvnc.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3

[program:sshd]
command=/usr/sbin/sshd -D
priority=46
autostart=true
autorestart=true
stopsignal=TERM
user=root
stdout_logfile=/var/log/supervisor/sshd.log
stderr_logfile=/var/log/supervisor/sshd.log

[program:ttyd]
command=/bin/bash /usr/local/bin/ttyd-wrapper.sh
priority=48
autostart=true
autorestart=true
stopsignal=TERM
user=root
environment=TTYD_USER=%(ENV_TTYD_USER)s,TTYD_PASSWORD=%(ENV_TTYD_PASSWORD)s,TTYD_PORT=7681
startsecs=10
startretries=5
exitcodes=0,130
stdout_logfile=/var/log/supervisor/ttyd.log
stderr_logfile=/var/log/supervisor/ttyd.log

[program:servicehealth]
command=/usr/local/bin/service-health.sh smart-monitor
priority=52
autostart=true
autorestart=true
user=root
startsecs=15
startretries=3
stdout_logfile=/var/log/supervisor/service-health.log
stderr_logfile=/var/log/supervisor/service-health.log

[program:setupdesktop]
command=/bin/sh -c "sleep 20; /usr/local/bin/wait-for-dbus.sh && /usr/local/bin/setup-desktop.sh"
priority=50
autostart=%(ENV_AUTOSTART_SETUPDESKTOP)s
autorestart=false
user=root
startsecs=15
startretries=2
exitcodes=0,1
stopwaitsecs=5
stdout_logfile=/var/log/supervisor/setup-desktop.log
stderr_logfile=/var/log/supervisor/setup-desktop.log

[program:systemvalidation]
command=/bin/sh -c "sleep 45; /usr/local/bin/system-validation.sh"
priority=55
autostart=%(ENV_AUTOSTART_SYSTEMVALIDATION)s
autorestart=false
user=root
startsecs=20
startretries=2
exitcodes=0,1
stopwaitsecs=5
stdout_logfile=/var/log/supervisor/system-validation.log
stderr_logfile=/var/log/supervisor/system-validation.log

