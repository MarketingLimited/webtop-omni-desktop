[supervisord]
nodaemon=true
user=root
loglevel=warn
minfds=1024
minprocs=200

[program:Xvfb]
command=/bin/bash -c ". /setup-xvfb-optimization.sh && /usr/bin/Xvfb :1 -screen 0 ${XVFB_RESOLUTION:-1920x1080x24} -dpi ${XVFB_DPI:-96} +extension GLX +render +extension RANDR +extension XFIXES +extension DAMAGE +extension COMPOSITE +extension MIT-SHM -noreset -ac -shmem -fbdir /tmp"
priority=10
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/xvfb.log
stderr_logfile=/var/log/supervisor/xvfb.log
environment=XVFB_PERFORMANCE_PROFILE="%(ENV_XVFB_PERFORMANCE_PROFILE)s",XVFB_RESOLUTION="%(ENV_XVFB_RESOLUTION)s",XVFB_DPI="%(ENV_XVFB_DPI)s"

[program:dbus]
command=/bin/sh -c "mkdir -p /run/dbus; /usr/bin/dbus-daemon --system --nofork --nosyslog"
priority=15
autostart=true
autorestart=true
user=root
startsecs=5
startretries=5
stdout_logfile=/var/log/supervisor/dbus.log
stderr_logfile=/var/log/supervisor/dbus.log

[program:pulseaudio]
command=/bin/sh -c "sleep 10; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; export PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse; mkdir -p /run/user/%(ENV_DEV_UID)s/pulse; chown %(ENV_DEV_USERNAME)s:%(ENV_DEV_USERNAME)s /run/user/%(ENV_DEV_UID)s/pulse; exec /usr/bin/pulseaudio --daemonize=no --disallow-exit --exit-idle-time=-1 --system=false --file=/home/%(ENV_DEV_USERNAME)s/.config/pulse/default.pa"
priority=25
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse,DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
startretries=3
startsecs=5
stdout_logfile=/var/log/supervisor/pulseaudio.log
stderr_logfile=/var/log/supervisor/pulseaudio.log

[program:KDE]
command=/bin/sh -c "sleep 15; export DISPLAY=:1; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; exec startplasma-x11"
priority=30
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startsecs=15
startretries=2
stdout_logfile=/var/log/supervisor/kde.log
stderr_logfile=/var/log/supervisor/kde.log

[program:X11VNC]
command=/bin/bash -c ". /usr/local/bin/setup-x11vnc-optimization.sh && sleep 35; exec /usr/local/bin/x11vnc-optimized -display :1 -rfbport 5901 -forever -shared -nopw -xkb -cursor arrow -cursorpos -ncache ${X11VNC_NCACHE:-10} -ncache_cr -wireframe -scrollcopyrect -fixscreen -threads -defer ${X11VNC_DEFER:-10} -wait ${X11VNC_WAIT:-5} -adaptive -progressive ${X11VNC_QUALITY:-6}"
priority=35
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=8
startretries=3
environment=X11VNC_PERFORMANCE_PROFILE="%(ENV_X11VNC_PERFORMANCE_PROFILE)s",X11VNC_QUALITY="%(ENV_X11VNC_QUALITY)s",X11VNC_ADAPTIVE="%(ENV_X11VNC_ADAPTIVE)s"
stdout_logfile=/var/log/supervisor/x11vnc.log
stderr_logfile=/var/log/supervisor/x11vnc.log

[program:noVNC]
command=/usr/bin/websockify --web=/usr/share/novnc/ 80 localhost:5901
priority=37
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/novnc.log
stderr_logfile=/var/log/supervisor/novnc.log


[program:sshd]
command=/usr/sbin/sshd -D
priority=42
autostart=true
autorestart=true
stopsignal=TERM
user=root
stdout_logfile=/var/log/supervisor/sshd.log
stderr_logfile=/var/log/supervisor/sshd.log

[program:ttyd]
command=/bin/bash /usr/local/bin/ttyd-wrapper.sh
priority=45
autostart=true
autorestart=true
stopsignal=TERM
user=root
environment=TTYD_USER=%(ENV_TTYD_USER)s,TTYD_PASSWORD=%(ENV_TTYD_PASSWORD)s,TTYD_PORT=7681
startsecs=10
startretries=5
exitcodes=0,130
stdout_logfile=/var/log/supervisor/ttyd.log
stderr_logfile=/var/log/supervisor/ttyd.log

[program:AudioValidation]
command=/bin/sh -c "sleep 25; /usr/local/bin/audio-validation.sh"
priority=26
autostart=true
autorestart=false
stopsignal=TERM
user=root
environment=DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
exitcodes=0,1
startsecs=0
stdout_logfile=/var/log/supervisor/audio-validation.log
stderr_logfile=/var/log/supervisor/audio-validation.log


[program:AudioMonitor]
command=/bin/sh -c "sleep 60; /usr/local/bin/audio-monitor.sh monitor"
priority=27
autostart=true
autorestart=unexpected
stopsignal=TERM
user=root
environment=DEV_USERNAME=%(ENV_DEV_USERNAME)s,DEV_UID=%(ENV_DEV_UID)s
startsecs=30
startretries=2
exitcodes=0,1
autorestart_backoff=60
stdout_logfile=/var/log/supervisor/audio-monitor.log
stderr_logfile=/var/log/supervisor/audio-monitor.log

[program:ServiceHealth]
command=/bin/sh -c "sleep 75; /usr/local/bin/service-health.sh smart-monitor"
priority=55
autostart=true
autorestart=unexpected
stopsignal=TERM
user=root
exitcodes=0,1
startsecs=20
startretries=1
autorestart_backoff=300
stdout_logfile=/var/log/supervisor/health.log
stderr_logfile=/var/log/supervisor/health.log

[program:CreateVirtualAudioDevices]
command=/bin/bash /usr/local/bin/create-virtual-audio-devices.sh
user=root
autostart=true
autorestart=false
startsecs=15
startretries=2
stdout_logfile=/var/log/supervisor/audio-devices.log
stderr_logfile=/var/log/supervisor/audio-devices.log
environment=DEV_USERNAME="%(ENV_DEV_USERNAME)s",DEV_UID="%(ENV_DEV_UID)s",DEV_GID="%(ENV_DEV_GID)s",XDG_RUNTIME_DIR="/run/user/%(ENV_DEV_UID)s"
priority=400
depends_on=pulseaudio
exitcodes=0,1

[program:SetupDesktop]
command=/bin/sh -c 'sleep 55; /usr/local/bin/setup-desktop.sh'
priority=50

[program:SetupUniversalAudio]
command=/bin/bash /usr/local/bin/setup-universal-audio.sh
user=root
autostart=true
autorestart=false
startsecs=10
startretries=2
stdout_logfile=/var/log/supervisor/universal-audio.log
stderr_logfile=/var/log/supervisor/universal-audio.log
priority=405
depends_on=noVNC
exitcodes=0,1

[program:AudioBridge]
command=/usr/bin/node /opt/audio-bridge/server.js
priority=25
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=3
stdout_logfile=/var/log/supervisor/audio-bridge.log
stderr_logfile=/var/log/supervisor/audio-bridge.log

[program:SystemValidation]
command=/bin/sh -c "sleep 120; /usr/local/bin/system-validation.sh --optimized"
priority=60
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0,1,2
startsecs=10
startretries=1
stdout_logfile=/var/log/supervisor/validation.log
stderr_logfile=/var/log/supervisor/validation.log

[group:core]
programs=Xvfb,dbus
priority=10

[group:audio]
programs=pulseaudio,AudioValidation,CreateVirtualAudioDevices,AudioMonitor,AudioBridge
priority=25

[group:desktop]
programs=KDE
priority=30

[group:remote]
programs=X11VNC,noVNC,sshd,ttyd
priority=40

[group:monitoring]
programs=ServiceHealth,SystemValidation
priority=55