[supervisord]
nodaemon=true
user=root

[program:pulseaudio]
command=/bin/sh -c "exec /usr/bin/pulseaudio --daemonize=no --disallow-exit --exit-idle-time=-1 --system=false --load='module-native-protocol-tcp auth-anonymous=1 port=4713' --load='module-null-sink sink_name=virtual_speaker' --load='module-remap-sink sink_name=marketing_audio master=virtual_speaker'"
priority=15
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse
startretries=3
startsecs=2

[program:polkitd]
command=/bin/sh -c 'while [ ! -S /run/dbus/system_bus_socket ]; do echo "[POLKIT] Waiting for D-Bus socket..."; sleep 1; done; echo "[POLKIT] D-Bus socket found, waiting 3 seconds..."; sleep 3; if ! pgrep -x dbus-daemon >/dev/null; then echo "[POLKIT] D-Bus daemon not running, exiting"; exit 1; fi; echo "[POLKIT] Starting polkitd daemon..."; exec /usr/lib/polkit-1/polkitd --no-debug'
priority=5
autostart=true
autorestart=false
user=root
environment=DBUS_SYSTEM_BUS_ADDRESS="unix:path=/run/dbus/system_bus_socket"
startretries=3
startsecs=5
exitcodes=0

[program:Xvnc]
command=/bin/sh -c "echo '[VNC] Cleaning up previous VNC sessions...'; vncserver -kill :1 2>/dev/null || true; rm -rf /tmp/.X1-lock /tmp/.X11-unix/X1 2>/dev/null || true; mkdir -p /tmp/.X11-unix; chmod 1777 /tmp/.X11-unix; echo '[VNC] Starting VNC server on :1...'; exec vncserver :1 -fg -geometry 1920x1080 -depth 24 -SecurityTypes None -localhost no -xstartup /home/%(ENV_DEV_USERNAME)s/.vnc/xstartup"
priority=10
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startsecs=8
startretries=3

[program:xpra]
command=/bin/sh -c "echo '[XPRA] Waiting for VNC to be ready...'; sleep 15; timeout=60; while [ $timeout -gt 0 ] && ! nc -z localhost 5901; do echo '[XPRA] Waiting for VNC on localhost:5901...'; sleep 2; timeout=$((timeout-2)); done; if ! nc -z localhost 5901; then echo '[XPRA] VNC not available after 60s, exiting'; exit 1; fi; echo '[XPRA] VNC ready, starting Xpra...'; exec /usr/bin/xpra shadow :1 --bind-tcp=0.0.0.0:14500 --html=on --daemon=no --no-speaker --no-microphone --exit-with-children=no"
priority=35
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startretries=3
startsecs=20

[program:noVNC]
command=/usr/bin/websockify --web=/usr/share/novnc/ 80 localhost:5901
priority=20
autostart=true
autorestart=true
stopsignal=TERM
user=root

[program:FlatpakInstaller]
command=/usr/local/bin/setup-flatpak-apps.sh
priority=30
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupDesktop]
command=/bin/sh -c 'echo "[DESKTOP] Waiting for VNC to be ready..."; timeout=120; while [ $timeout -gt 0 ] && ! nc -z localhost 5901; do echo "[DESKTOP] Waiting for VNC..."; sleep 2; timeout=$((timeout-2)); done; if ! nc -z localhost 5901; then echo "[DESKTOP] VNC not ready, continuing anyway..."; fi; echo "[DESKTOP] Starting desktop setup..."; exec /usr/local/bin/setup-desktop.sh'
priority=40
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0
stdout_logfile=/var/log/supervisor/setup-desktop.log
stderr_logfile=/var/log/supervisor/setup-desktop.log

[program:SetupMarketing]
command=/bin/sh -c 'sleep 5; /usr/local/bin/setup-marketing-shortcuts.sh'
priority=45
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupDevelopment]
command=/usr/local/bin/setup-development.sh
priority=46
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupWine]
command=/usr/local/bin/setup-wine.sh
priority=47
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupWaydroid]
command=/bin/sh -c 'sleep 8; /usr/local/bin/setup-waydroid.sh'
priority=48
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupVideoEditing]
command=/bin/sh -c 'sleep 6; /usr/local/bin/setup-video-editing.sh'
priority=49
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:FixPermissions]
command=/usr/local/bin/fix-permissions.sh
priority=99
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:sshd]
command=/bin/sh -c 'mkdir -p /run/sshd; if ! /usr/sbin/sshd -t; then echo "SSH config test failed"; exit 1; fi; exec /usr/sbin/sshd -D -e'
priority=25
autostart=true
autorestart=true
stopsignal=TERM
user=root
startretries=2
startsecs=3

[program:ttyd]
command=/bin/sh -c "/usr/bin/ttyd -p 7681 -c ${TTYD_USER}:${TTYD_PASSWORD} bash"
priority=60
autostart=true
autorestart=true
stopsignal=TERM
user=root
