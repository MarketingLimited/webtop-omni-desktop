[supervisord]
nodaemon=true
user=root
loglevel=info

[program:Xvfb]
command=/usr/bin/Xvfb :1 -screen 0 1920x1080x24 -dpi 96 +extension GLX +render -noreset -ac
priority=10
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/xvfb.log
stderr_logfile=/var/log/supervisor/xvfb.log

[program:dbus]
command=/usr/bin/dbus-daemon --system --nofork --nosyslog
priority=15
autostart=true
autorestart=true
user=root
startsecs=3
startretries=3
stdout_logfile=/var/log/supervisor/dbus.log
stderr_logfile=/var/log/supervisor/dbus.log

[program:pulseaudio]
command=/bin/sh -c "sleep 8; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; export PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse; mkdir -p /run/user/%(ENV_DEV_UID)s/pulse; exec /usr/bin/pulseaudio --daemonize=no --disallow-exit --exit-idle-time=-1 --system=false --file=/home/%(ENV_DEV_USERNAME)s/.config/pulse/default.pa"
priority=25
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse
startretries=3
startsecs=5
stdout_logfile=/var/log/supervisor/pulseaudio.log
stderr_logfile=/var/log/supervisor/pulseaudio.log

[program:KDE]
command=/bin/sh -c "sleep 15; export DISPLAY=:1; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; exec startplasma-x11"
priority=30
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startsecs=15
startretries=2
stdout_logfile=/var/log/supervisor/kde.log
stderr_logfile=/var/log/supervisor/kde.log

[program:X11VNC]
command=/bin/sh -c "sleep 35; exec /usr/bin/x11vnc -display :1 -rfbport 5901 -forever -shared -nopw -xkb -noxrecord -noxfixes -noxdamage -wait 5"
priority=35
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=8
startretries=3
stdout_logfile=/var/log/supervisor/x11vnc.log
stderr_logfile=/var/log/supervisor/x11vnc.log

[program:noVNC]
command=/usr/bin/websockify --web=/usr/share/novnc/ 80 localhost:5901
priority=37
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/novnc.log
stderr_logfile=/var/log/supervisor/novnc.log

[program:Xpra]
command=/bin/sh -c "sleep 50; export DISPLAY=:1; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; exec /usr/bin/xpra start --bind-tcp=0.0.0.0:14500 --html=on --attach :1 --sharing=yes --daemon=no --pulseaudio=yes --speaker=on --microphone=on"
priority=40
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PULSE_SERVER=unix:/run/user/%(ENV_DEV_UID)s/pulse/native
startsecs=20
startretries=2
stdout_logfile=/var/log/supervisor/xpra.log
stderr_logfile=/var/log/supervisor/xpra.log

[program:sshd]
command=/usr/sbin/sshd -D
priority=42
autostart=true
autorestart=true
stopsignal=TERM
user=root
stdout_logfile=/var/log/supervisor/sshd.log
stderr_logfile=/var/log/supervisor/sshd.log

[program:ttyd]
command=/usr/local/bin/ttyd-wrapper.sh
priority=45
autostart=true
autorestart=true
stopsignal=TERM
user=root
environment=TTYD_USER=%(ENV_TTYD_USER)s,TTYD_PASSWORD=%(ENV_TTYD_PASSWORD)s,TTYD_PORT=7681
startsecs=10
startretries=5
exitcodes=0,130
stdout_logfile=/var/log/supervisor/ttyd.log
stderr_logfile=/var/log/supervisor/ttyd.log

[program:AudioValidation]
command=/bin/sh -c "sleep 95; /usr/local/bin/audio-validation.sh"
priority=58
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0,1
startsecs=0
stdout_logfile=/var/log/supervisor/audio-validation.log
stderr_logfile=/var/log/supervisor/audio-validation.log

[program:AudioMonitor]
command=/bin/sh -c "sleep 90; /usr/local/bin/audio-monitor.sh monitor > /var/log/supervisor/audio-monitor.log 2>&1"
priority=58
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=10
startretries=2
exitcodes=0,1,2
stdout_logfile=/var/log/supervisor/audio-monitor.log
stderr_logfile=/var/log/supervisor/audio-monitor.log

[program:ServiceHealth]
command=/bin/sh -c "sleep 75; while true; do /usr/local/bin/service-health.sh status; sleep 600; done"
priority=55
autostart=true
autorestart=true
stopsignal=TERM
user=root
exitcodes=0,1
startsecs=10
startretries=2
stdout_logfile=/var/log/supervisor/health.log
stderr_logfile=/var/log/supervisor/health.log

[program:SetupDesktop]
command=/bin/sh -c 'sleep 55; /usr/local/bin/setup-desktop.sh'
priority=50
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0
stdout_logfile=/var/log/supervisor/setup.log
stderr_logfile=/var/log/supervisor/setup.log

[program:SystemValidation]
command=/bin/sh -c "sleep 120; /usr/local/bin/system-validation.sh"
priority=60
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0,1
startsecs=0
stdout_logfile=/var/log/supervisor/validation.log
stderr_logfile=/var/log/supervisor/validation.log