[supervisord]
nodaemon=true
user=root

[program:pulseaudio]
command=/bin/sh -c "exec /usr/bin/pulseaudio --daemonize=no --disallow-exit --exit-idle-time=-1 --system=false --load='module-native-protocol-tcp auth-anonymous=1 port=4713' --load='module-null-sink sink_name=virtual_speaker' --load='module-remap-sink sink_name=marketing_audio master=virtual_speaker'"
priority=15
autostart=true
autorestart=true
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s,PULSE_RUNTIME_PATH=/run/user/%(ENV_DEV_UID)s/pulse
startretries=3
startsecs=2

[program:Xvfb]
command=/bin/sh -c "echo '[XVFB] Starting virtual display server...'; exec /usr/bin/Xvfb :1 -screen 0 1920x1080x24 -dpi 96 +extension GLX +render -noreset -ac"
priority=10
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=3
startretries=3

[program:KDE]
command=/bin/sh -c "echo '[KDE] Waiting for display...'; while ! xdpyinfo -display :1 >/dev/null 2>&1; do sleep 1; done; echo '[KDE] Display ready, starting KDE Plasma...'; export DISPLAY=:1; export XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s; export HOME=/home/%(ENV_DEV_USERNAME)s; exec dbus-launch --exit-with-session startplasma-x11"
priority=20
autostart=true
autorestart=true
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startsecs=5
startretries=2

[program:X11VNC]
command=/bin/sh -c "echo '[X11VNC] Waiting for KDE to initialize...'; sleep 10; while ! xdpyinfo -display :1 >/dev/null 2>&1; do sleep 1; done; echo '[X11VNC] Starting X11VNC server on port 5901...'; exec /usr/bin/x11vnc -display :1 -rfbport 5901 -forever -shared -nopw -bg -xkb -noxrecord -noxfixes -noxdamage -wait 5 -cursor arrow"
priority=25
autostart=true
autorestart=true
stopsignal=TERM
user=root
startsecs=5
startretries=3

[program:xpra]
command=/bin/sh -c "echo '[XPRA] Waiting for X11VNC to be ready...'; sleep 15; timeout=60; while [ $timeout -gt 0 ] && ! nc -z localhost 5901; do echo '[XPRA] Waiting for X11VNC on localhost:5901...'; sleep 2; timeout=$((timeout-2)); done; if ! nc -z localhost 5901; then echo '[XPRA] X11VNC not available after 60s, continuing without Xpra'; exit 0; fi; echo '[XPRA] X11VNC ready, starting Xpra...'; exec /usr/bin/xpra shadow :1 --bind-tcp=0.0.0.0:14500 --html=on --daemon=no --no-speaker --no-microphone --exit-with-children=no"
priority=30
autostart=true
autorestart=false
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=DISPLAY=:1,HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,XDG_RUNTIME_DIR=/run/user/%(ENV_DEV_UID)s
startretries=1
startsecs=15

[program:noVNC]
command=/usr/bin/websockify --web=/usr/share/novnc/ 80 localhost:5901
priority=35
autostart=true
autorestart=true
stopsignal=TERM
user=root

[program:FlatpakInstaller]
command=/usr/local/bin/setup-flatpak-apps.sh
priority=40
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupDesktop]
command=/bin/sh -c 'echo "[DESKTOP] Waiting for display and KDE..."; timeout=60; while [ $timeout -gt 0 ] && ! xdpyinfo -display :1 >/dev/null 2>&1; do sleep 2; timeout=$((timeout-2)); done; sleep 5; echo "[DESKTOP] Starting desktop setup..."; exec /usr/local/bin/setup-desktop.sh'
priority=45
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0
stdout_logfile=/var/log/supervisor/setup-desktop.log
stderr_logfile=/var/log/supervisor/setup-desktop.log

[program:SetupMarketing]
command=/bin/sh -c 'sleep 10; /usr/local/bin/setup-marketing-shortcuts.sh'
priority=50
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupDevelopment]
command=/bin/sh -c 'sleep 15; /usr/local/bin/setup-development.sh'
priority=55
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupWine]
command=/bin/sh -c 'sleep 20; /usr/local/bin/setup-wine.sh'
priority=60
autostart=true
autorestart=false
stopsignal=TERM
user=%(ENV_DEV_USERNAME)s
environment=HOME=/home/%(ENV_DEV_USERNAME)s,USER=%(ENV_DEV_USERNAME)s,DISPLAY=:1
exitcodes=0
startsecs=0

[program:SetupWaydroid]
command=/bin/sh -c 'sleep 25; /usr/local/bin/setup-waydroid.sh'
priority=65
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:SetupVideoEditing]
command=/bin/sh -c 'sleep 30; /usr/local/bin/setup-video-editing.sh'
priority=70
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0

[program:ttyd]
command=/usr/bin/ttyd -p 7681 -u %(ENV_TTYD_USER)s -c %(ENV_TTYD_PASSWORD)s bash
priority=75
autostart=true
autorestart=true
stopsignal=TERM
user=root

[program:sshd]
command=/usr/sbin/sshd -D
priority=80
autostart=true
autorestart=true
stopsignal=TERM
user=root

[program:FixPermissions]
command=/usr/local/bin/fix-permissions.sh
priority=85
autostart=true
autorestart=false
stopsignal=TERM
user=root
exitcodes=0
startsecs=0